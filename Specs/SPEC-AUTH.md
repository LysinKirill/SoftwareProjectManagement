# Спецификация модуля аутентификации и авторизации (SPEC-AUTH)

**ID документа:** SPEC-AUTH  
**Версия:** 1.0  
**Дата:** 11.04.2025  
**Ответственный:** Лысин К.С.

## 1. Область действия
Модуль отвечает за OAuth 2.0 аутентификацию, хранение и обновление токенов доступа, управление пользовательскими сессиями и профилями.

## 2. Связанные требования
- rq-1: Аутентификация через Google/Яндекс
- rq-2: Безопасное хранение и обновление токенов
- rq-8: Хранение профилей пользователей
- rq-9: Использование Redis для кэширования

## 3. Критерии приёмки (Acceptance Criteria)

### 3.1. Аутентификация через OAuth 2.0 провайдеров
**AC-001**: Пользователь может войти через Google OAuth 2.0. После успешной аутентификации возвращается access token, который сохраняется в системе.  
**Метод верификации:** VM-001

**AC-002**: Пользователь может войти через Яндекс OAuth 2.0. После успешной аутентификации возвращается access token, который сохраняется в системе.  
**Метод верификации:** VM-001

**AC-003**: При неудачной аутентификации пользователь получает понятное сообщение об ошибке.  
**Метод верификации:** VM-002

### 3.2. Управление токенами
**AC-004**: Токены доступа шифруются перед сохранением в БД (алгоритм AES-256).  
**Метод верификации:** VM-003

**AC-005**: Истёкшие токены автоматически обновляются без вмешательства пользователя.  
**Метод верификации:** VM-004

**AC-006**: Refresh tokens хранятся отдельно от access tokens с усиленными мерами безопасности.  
**Метод верификации:** VM-003

### 3.3. Хранение профилей пользователей
**AC-007**: Профиль пользователя (id, email, провайдер, дата регистрации) сохраняется в PostgreSQL/YDB при первой аутентификации.  
**Метод верификации:** VM-005

**AC-008**: При повторной аутентификации существующего пользователя обновляется timestamp последнего входа.  
**Метод верификации:** VM-005

### 3.4. Кэширование
**AC-009**: Данные пользовательских сессий кэшируются в Redis со сроком жизни 1 час.  
**Метод верификации:** VM-006

**AC-010**: При запросе данных пользователя сначала проверяется кэш, затем БД.  
**Метод верификации:** VM-006

## 4. Методы верификации (Verification Methods)

**VM-001**: Демонстрация входа через Google/Яндекс в приложении. Проверка получения и сохранения токена.  
**Тип:** Demo

**VM-002**: Тестирование сценариев неудачной аутентификации (неверные credentials, отключенный OAuth).  
**Тип:** Test

**VM-003**: Инспекция БД для проверки шифрования токенов. Проверка, что токены не хранятся в plain text.  
**Тип:** Inspection

**VM-004**: Автоматическое тестирование обновления токенов с использованием mock OAuth провайдера.  
**Тип:** Test

**VM-005**: Проверка запросов к БД при создании/обновлении профилей пользователей.  
**Тип:** Inspection

**VM-006**: Проверка попаданий в кэш через мониторинг Redis и анализ логов запросов.  
**Тип:** Analysis

## 5. Технические детали

### 5.1. Технологии
- ASP.NET Core 8
- Microsoft.AspNetCore.Authentication.Google
- Microsoft.AspNetCore.Authentication.Yandex
- Entity Framework Core
- PostgreSQL/YDB
- Redis (StackExchange.Redis)