# Спецификация серверной части и API (SPEC-BACKEND)

**ID документа:** SPEC-BACKEND  
**Версия:** 1.0  
**Дата:** 11.04.2025  
**Ответственный:** Лысин К.С.

## 1. Область действия
Серверная часть системы "Personage": REST API, бизнес-логика, работа с БД, обработка событий, интеграция с внешними сервисами и LLM.

## 2. Связанные требования
- rq-16: REST API для фронтенда
- rq-19: Интерфейс передачи событий
- rq-20: Доступность системы
- rq-21: Автоматический перезапуск
- rq-23: Технологии бэкенда
- rq-24: Работа с БД

## 3. Критерии приёмки (Acceptance Criteria)

### 3.1. REST API
**AC-060**: Фронтенд взаимодействует с бэкендом через REST API (JSON, HTTPS).  
**Метод верификации:** VM-056

**AC-061**: Документация API в формате OpenAPI 3.0 доступна по `/swagger` или `/api-docs`.  
**Метод верификации:** VM-057

**AC-062**: Все эндпоинты требуют аутентификации через Bearer token (кроме auth endpoints).  
**Метод верификации:** VM-058

**AC-063**: Поддерживается версионирование API через URL path (`/api/v1/...`).  
**Метод верификации:** VM-059

**AC-064**: Rate limiting: 100 запросов в минуту на пользователя.  
**Метод верификации:** VM-060

### 3.2. Брокер событий (EventBus)
**AC-065**: Структурированные события передаются в модуль анализа через Kafka/gRPC.  
**Метод верификации:** VM-061

**AC-066**: Гарантируется доставка сообщений (at-least-once семантика).  
**Метод верификации:** VM-062

**AC-067**: Поддерживается dead letter queue для неудачно обработанных сообщений.  
**Метод верификации:** VM-063

**AC-068**: Мониторинг очереди сообщений: количество в очереди, скорость обработки.  
**Метод верификации:** VM-064

### 3.3. Надёжность и отказоустойчивость
**AC-069**: Uptime сервиса ≥99% в месячном измерении.  
**Метод верификации:** VM-065

**AC-070**: Автоматический перезапуск контейнера при падении в течение 10 минут.  
**Метод верификации:** VM-066

**AC-071**: Health check эндпоинт `/health` возвращает статус 200 при работоспособности.  
**Метод верификации:** VM-067

**AC-072**: Circuit breaker для внешних зависимостей (LLM API, внешние сервисы).  
**Метод верификации:** VM-068

### 3.4. Производительность
**AC-073**: Время ответа API p95 < 500ms для read операций.  
**Метод верификации:** VM-069

**AC-074**: Время ответа API p95 < 1s для write операций.  
**Метод верификации:** VM-070

**AC-075**: Поддержка ≥1000 одновременных пользователей.  
**Метод верификации:** VM-071

**AC-076**: Кэширование частых запросов в Redis.  
**Метод верификации:** VM-072

### 3.5. Безопасность
**AC-077**: Все данные передаются по HTTPS (TLS 1.3).  
**Метод верификации:** VM-073

**AC-078**: SQL injection protection через параметризованные запросы.  
**Метод верификации:** VM-074

**AC-079**: Валидация входных данных на всех эндпоинтах.  
**Метод верификации:** VM-075

**AC-080**: Логирование аудита: кто, когда, что изменил.  
**Метод верификации:** VM-076

### 3.6. Работа с базой данных
**AC-081**: Используется Entity Framework Core для работы с PostgreSQL.  
**Метод верификации:** VM-077

**AC-082**: Миграции БД применяются автоматически при развёртывании.  
**Метод верификации:** VM-078

**AC-083**: Репликация БД для отказоустойчивости (master-slave).  
**Метод верификации:** VM-079

**AC-084**: Регулярные backup БД (раз в сутки).  
**Метод верификации:** VM-080

## 4. Методы верификации (Verification Methods)

**VM-056**: Тестирование REST API через Postman/curl.  
**Тип:** Test

**VM-057**: Проверка доступности Swagger UI.  
**Тип:** Inspection

**VM-058**: Тестирование доступа без токена/с невалидным токеном.  
**Тип:** Test

**VM-059**: Проверка структуры URL API.  
**Тип:** Inspection

**VM-060**: Нагрузочное тестирование rate limiting.  
**Тип:** Test

**VM-061**: Демонстрация отправки/получения сообщений через Kafka.  
**Тип:** Demo

**VM-062**: Тестирование гарантий доставки при сбоях.  
**Тип:** Test

**VM-063**: Проверка наличия и работы DLQ.  
**Тип:** Inspection

**VM-064**: Мониторинг метрик очереди через Grafana.  
**Тип:** Analysis

**VM-065**: Мониторинг uptime через Prometheus/Grafana.  
**Тип:** Analysis

**VM-066**: Тестирование автоматического перезапуска (kill процесса).  
**Тип:** Test

**VM-067**: Проверка health check эндпоинта.  
**Тип:** Inspection

**VM-068**: Тестирование circuit breaker при недоступности внешнего API.  
**Тип:** Test

**VM-069**: Нагрузочное тестирование read операций.  
**Тип:** Test

**VM-070**: Нагрузочное тестирование write операций.  
**Тип:** Test

**VM-071**: Стресс-тестирование с 1000+ одновременных пользователей.  
**Тип:** Test

**VM-072**: Проверка попаданий в кэш через метрики Redis.  
**Тип:** Analysis

**VM-073**: Проверка SSL/TLS настроек.  
**Тип:** Inspection

**VM-074**: Тестирование на SQL injection.  
**Тип:** Test

**VM-075**: Инжекция некорректных данных в API.  
**Тип:** Test

**VM-076**: Проверка логов аудита.  
**Тип:** Inspection

**VM-077**: Проверка конфигурации Entity Framework.  
**Тип:** Inspection

**VM-078**: Тестирование применения миграций.  
**Тип:** Test

**VM-079**: Тестирование failover при падении master БД.  
**Тип:** Test

**VM-080**: Проверка наличия и восстановления backup.  
**Тип:** Inspection

## 5. Технические детали

### 5.1. Технологии
- .NET 8 / ASP.NET Core
- Entity Framework Core 8
- PostgreSQL 15+
- Redis 7+
- Kafka 3.4+ (или Yandex Message Queue)
- gRPC для внутренней коммуникации
- Docker для контейнеризации

### 5.2. Архитектура
```
Клиент → API Gateway → Auth Service → Business Logic → Database
↓
Message Queue → Processing Service
↓
External APIs
```


### 5.3. Основные эндпоинты API
```http
# Аутентификация
POST   /api/v1/auth/google
POST   /api/v1/auth/yandex
POST   /api/v1/auth/telegram
POST   /api/v1/auth/refresh

# События
GET    /api/v1/events?from=2025-04-15
GET    /api/v1/events/{id}
POST   /api/v1/events
PUT    /api/v1/events/{id}
DELETE /api/v1/events/{id}

# Приоритеты
PUT    /api/v1/events/{id}/priority
POST   /api/v1/events/batch/priority

# Внешние сервисы
GET    /api/v1/connectors/status
POST   /api/v1/connectors/sync

# Системные
GET    /health
GET    /metrics
GET    /swagger
```

### 5.4. Конфигурация
```json
{
  "Database": {
    "ConnectionString": "Host=localhost;Database=personage;Username=user;Password=pass",
    "Provider": "PostgreSQL"
  },
  "Redis": {
    "ConnectionString": "localhost:6379",
    "InstanceName": "personage"
  },
  "Kafka": {
    "BootstrapServers": "localhost:9092",
    "EventsTopic": "personage-events",
    "GroupId": "personage-processor"
  },
  "Api": {
    "RateLimit": 100,
    "TimeoutSeconds": 30,
    "CorsOrigins": ["http://localhost:3000"]
  }
}
```

### 5.5. Мониторинг
- Метрики: Prometheus + Grafana
- Логи: ELK Stack (Elasticsearch, Logstash, Kibana)
- Трейсинг: Jaeger или OpenTelemetry
- Оповещения: через Telegram/Slack при инцидентах

### 5.6. Масштабирование
- Горизонтальное масштабирование API сервисов
- Read-only реплики для БД
- Redis cluster для распределённого кэша
- Партиционирование Kafka топиков