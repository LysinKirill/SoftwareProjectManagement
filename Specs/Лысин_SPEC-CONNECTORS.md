# Спецификация модулей коннекторов внешних сервисов (SPEC-CONNECTORS)

**ID документа:** SPEC-CONNECTORS  
**Версия:** 1.0  
**Дата:** 11.04.2025  
**Ответственный:** Лысин К.С.

## 1. Область действия
Модули для интеграции с внешними сервисами: Google Calendar, Gmail, Telegram. Обеспечивают периодический опрос API, получение данных и их первичную обработку.

## 2. Связанные требования
- rq-3: Коннектор Google Calendar
- rq-4: Коннектор Gmail
- rq-5: Коннектор Telegram
- rq-17: Взаимодействие с внешними API
- rq-22: Обработка некорректных данных

## 3. Критерии приёмки (Acceptance Criteria)

### 3.1. Google Calendar Connector
**AC-011**: Коннектор опрашивает Google Calendar API каждые 5 минут для получения новых событий.  
**Метод верификации:** VM-007

**AC-012**: Извлечённые события содержат: название, время начала/окончания, участников, описание, местоположение.  
**Метод верификации:** VM-008

**AC-013**: Поддерживается пагинация при получении большого количества событий.  
**Метод верификации:** VM-009

### 3.2. Gmail Connector
**AC-014**: Коннектор читает письма из inbox каждые 10 минут, начиная с последнего обработанного письма.  
**Метод верификации:** VM-010

**AC-015**: Из письма извлекаются: тема, тело (plain text и HTML), дата, отправитель, получатели, вложения (ссылки на файлы).  
**Метод верификации:** VM-011

**AC-016**: Письма с пометкой "spam" или "trash" игнорируются.  
**Метод верификации:** VM-012

### 3.3. Telegram Connector
**AC-017**: Коннектор подключается к Telegram API через библиотеку `telethon` с использованием user session.  
**Метод верификации:** VM-013

**AC-018**: Сообщения из разрешённых чатов (список configurable) сохраняются с метаданными: текст, дата, отправитель, тип сообщения (текст/фото/документ).  
**Метод верификации:** VM-014

**AC-019**: Поддерживается обработка только сообщений, отправленных за последние 24 часа (во избежание перегрузки).  
**Метод верификации:** VM-015

### 3.4. Обработка ошибок и надёжность
**AC-020**: Некорректные ответы API (ошибки 4xx/5xx) логируются с деталями, сервис продолжает работу.  
**Метод верификации:** VM-016

**AC-021**: При повторных ошибках подключения к API используется экспоненциальная отсрочка (exponential backoff).  
**Метод верификации:** VM-017

**AC-022**: Коннекторы сохраняют состояние последней успешной синхронизации для каждого пользователя.  
**Метод верификации:** VM-018

## 4. Методы верификации (Verification Methods)

**VM-007**: Тестирование периодического опроса через mock Google Calendar API.  
**Тип:** Test

**VM-008**: Инспекция извлечённых данных на полноту и корректность полей.  
**Тип:** Inspection

**VM-009**: Тестирование с большим объемом данных (>1000 событий) для проверки пагинации.  
**Тип:** Test

**VM-010**: Демонстрация получения писем из тестового Gmail аккаунта.  
**Тип:** Demo

**VM-011**: Сравнение извлечённых данных письма с оригиналом.  
**Тип:** Inspection

**VM-012**: Проверка фильтрации спам-писей.  
**Тип:** Test

**VM-013**: Демонстрация подключения к Telegram и получения сообщений.  
**Тип:** Demo

**VM-014**: Проверка сохранения метаданных сообщений в БД.  
**Тип:** Inspection

**VM-015**: Тестирование временного фильтра (только последние 24 часа).  
**Тип:** Test

**VM-016**: Инжекция ошибок API и проверка логирования и восстановления.  
**Тип:** Test

**VM-017**: Тестирование exponential backoff при сбоях сети.  
**Тип:** Test

**VM-018**: Проверка сохранения и восстановления состояния синхронизации.  
**Тип:** Inspection

## 5. Технические детали

### 5.1. Технологии
- Google Calendar: Google.Apis.Calendar.v3
- Gmail: Google.Apis.Gmail.v1
- Telegram: Telethon (Python)
- .NET: BackgroundService для периодических задач
- Polly для retry policies

### 5.2. Конфигурация
Пример возможного вида конфигурационного файла коннекторов
```json
{
  "Connectors": {
    "GoogleCalendar": {
      "PollingIntervalMinutes": 5,
      "MaxEventsPerRequest": 250,
      "TimeZone": "Europe/Moscow"
    },
    "Gmail": {
      "PollingIntervalMinutes": 10,
      "MaxEmailsPerRequest": 100,
      "IgnoreLabels": ["SPAM", "TRASH"]
    },
    "Telegram": {
      "ApiId": "env:TELEGRAM_API_ID",
      "ApiHash": "env:TELEGRAM_API_HASH",
      "AllowedChats": ["@work_chat", "@family_chat"],
      "MaxMessagesPerChat": 100
    }
  }
}