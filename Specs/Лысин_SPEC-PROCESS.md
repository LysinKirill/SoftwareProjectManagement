# Спецификация модуля обработки данных и LLM (SPEC-PROCESS)
**ID документа:** SPEC-PROCESS  
**Версия:** 1.0  
**Дата:** 11.04.2025  
**Ответственный:** Лысин К.С.  

## 1. Область действия
Модуль обработки неструктурированных данных, классификации, суммаризации и извлечения сущностей с использованием LLM. Преобразование сырых данных в структурированные события.

## 2. Связанные требования
- rq-6: Предварительная обработка и классификация данных
- rq-7: Использование LLM-моделей
- rq-18: Взаимодействие с LLM-сервисом

## 3. Критерии приёмки (Acceptance Criteria)

### 3.1. Предварительная обработка данных
**AC-023**: Входящие неструктурированные данные (письма, сообщения) преобразуются в JSON-события с полями: `type`, `title`, `date`, `participants`, `summary`, `priority`, `source`.  
**Метод верификации:** VM-019

**AC-024**: Обработка поддерживает данные на русском и английском языках.  
**Метод верификации:** VM-020

**AC-025**: Дубликаты событий (по content hash) игнорируются.  
**Метод верификации:** VM-021

### 3.2. Классификация и извлечение сущностей
**AC-026**: Точность извлечения сущностей (дата, время, участники, место) ≥85% на тестовой выборке.  
**Метод верификации:** VM-022

**AC-027**: Классификация типа события: встреча, задача, напоминание, событие, дедлайн.  
**Метод верификации:** VM-023

**AC-028**: Извлечение приоритета из контекста: высокий, средний, низкий.  
**Метод верификации:** VM-024

### 3.3. Взаимодействие с LLM
**AC-029**: Запрос к LLM выполняется через REST/gRPC API.  
**Метод верификации:** VM-025

**AC-030**: Время ответа LLM <2 секунд в 90% случаев (p90).  
**Метод верификации:** VM-026

**AC-031**: Поддерживается fallback на более простую модель при недоступности основной LLM.  
**Метод верификации:** VM-027

### 3.4. Качество и валидация
**AC-032**: Обработанные события проходят валидацию на обязательные поля перед сохранением.  
**Метод верификации:** VM-028

**AC-033**: Пользователь может корректировать результаты классификации через UI.  
**Метод верификации:** VM-029

**AC-034**: Система обучается на корректировках пользователя (feedback loop).  
**Метод верификации:** VM-030

## 4. Методы верификации (Verification Methods)

**VM-019**: Инспекция выходного JSON на соответствие схеме.  
**Тип:** Inspection

**VM-020**: Тестирование обработки текстов на русском и английском языках.  
**Тип:** Test

**VM-021**: Проверка фильтрации дубликатов через content hashing.  
**Тип:** Test

**VM-022**: Анализ точности на размеченном датасете из 1000 примеров.  
**Тип:** Analysis

**VM-023**: Демонстрация классификации различных типов событий.  
**Тип:** Demo

**VM-024**: Проверка корректности определения приоритета.  
**Тип:** Test

**VM-025**: Проверка подключения к LLM API (OpenAI/локальная).  
**Тип:** Inspection

**VM-026**: Измерение времени ответа LLM через метрики Prometheus.  
**Тип:** Analysis

**VM-027**: Тестирование fallback механизма при отказе LLM.  
**Тип:** Test

**VM-028**: Валидация обязательных полей событий.  
**Тип:** Inspection

**VM-029**: Демонстрация корректировки классификации через UI.  
**Тип:** Demo

**VM-030**: Проверка сохранения feedback для обучения.  
**Тип:** Inspection

## 5. Технические детали

### 5.1. Технологии
- Python 3.11+
- FastAPI для REST API
- gRPC для внутренней коммуникации
- OpenAI API или локальная LLM (Llama 2, Mistral)
- spaCy для NLP preprocessing
- Pydantic для валидации данных

### 5.2. Архитектура
Raw Data → Preprocessor → LLM Classifier → Entity Extractor → Validator → Structured Event



### 5.3. Конфигурация LLM
Пример возможного содержания конфигурационного файла
```yaml
llm:
  provider: "openai"  # или "local"
  openai:
    model: "gpt-4-turbo-preview"
    api_key: "env:OPENAI_API_KEY"
    temperature: 0.3
    max_tokens: 1000
  local:
    model_path: "/models/llama-2-7b-chat.Q4_K_M.gguf"
    context_size: 4096
  fallback_enabled: true
  fallback_model: "rule_based"
```

### 5.4. Схема выходного события
Пример который передаёт суть извлечения фичей события (traits), но НЕ является реальным контрактом обработанного события с извлеченными фичами
```json
{
  "event_id": "uuid",
  "user_id": "uuid",
  "type": "meeting|task|reminder|event|deadline",
  "title": "Название события",
  "description": "Полное описание",
  "date": "2025-04-15",
  "time": "14:30",
  "duration_minutes": 60,
  "participants": ["user1@email.com", "user2@email.com"],
  "location": "Офис 305",
  "priority": "high|medium|low",
  "source": "gmail|google_calendar|telegram",
  "source_id": "external_id",
  "confidence": 0.85,
  "processed_at": "2025-04-11T10:30:00Z"
}
```

### 5.5. Производительность
- Обработка: ≥100 событий в минуту на одном ядре
- Задержка: <5 секунд от получения сырых данных до структурированного события
- Потребление памяти: <2 ГБ для локальной LLM